name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    strategy:
      matrix:
        include:
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: envcli.exe
            artifact_asset: envcli-x86_64-pc-windows-msvc.exe
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: envcli
            artifact_asset: envcli-x86_64-unknown-linux-gnu
          # Linux ARM64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: envcli
            artifact_asset: envcli-aarch64-unknown-linux-gnu
          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: envcli
            artifact_asset: envcli-x86_64-apple-darwin
          # macOS ARM64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: envcli
            artifact_asset: envcli-aarch64-apple-darwin

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install aarch64 cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: |
          # è®¾ç½® aarch64 äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
          if [ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
          fi

          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          cargo build --release --target ${{ matrix.target }}

          # å¤åˆ¶åˆ°æœ€ç»ˆæ–‡ä»¶å
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} target/${{ matrix.artifact_asset }}
        shell: bash

      - name: Generate SHA256 hash
        id: hash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            # Windows: ä½¿ç”¨ PowerShell è®¡ç®— SHA256ï¼Œè½¬ä¸ºå°å†™å¹¶å»æ‰æ¢è¡Œ
            powershell -Command "(Get-FileHash -Algorithm SHA256 target/${{ matrix.artifact_asset }}).Hash.ToLower() | Out-File -Encoding ASCII -NoNewline target/${{ matrix.artifact_asset }}.sha256"
          else
            # Unix-like: ç›´æ¥ä½¿ç”¨ shasum
            shasum -a 256 target/${{ matrix.artifact_asset }} | cut -d' ' -f1 > target/${{ matrix.artifact_asset }}.sha256
          fi
        shell: bash

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_asset }}
          path: target/${{ matrix.artifact_asset }}
          retention-days: 1

      - name: Upload SHA256 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_asset }}.sha256
          path: target/${{ matrix.artifact_asset }}.sha256
          retention-days: 1

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # å¤åˆ¶æ‰€æœ‰ artifacts åˆ° release ç›®å½•
          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              # å¤åˆ¶è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ° release ç›®å½•ï¼ˆä¿ç•™æ–‡ä»¶åï¼‰
              cp "$artifact_dir"* release/ 2>/dev/null || true
            fi
          done

          echo "=== Release files ==="
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸš€ EnvCLI Release

            ### ğŸ“¦ å¯ç”¨äºŒè¿›åˆ¶æ–‡ä»¶

            | å¹³å° | æ¶æ„ | æ–‡ä»¶å |
            |------|------|--------|
            | Windows | x86_64 | `envcli-x86_64-pc-windows-msvc.exe` |
            | Linux | x86_64 | `envcli-x86_64-unknown-linux-gnu` |
            | Linux | ARM64 | `envcli-aarch64-unknown-linux-gnu` |
            | macOS | x86_64 | `envcli-x86_64-apple-darwin` |
            | macOS | ARM64 | `envcli-aarch64-apple-darwin` |

            ### ğŸ”§ å®‰è£…æ–¹æ³•

            #### Linux x86_64
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/envcli-x86_64-unknown-linux-gnu
            chmod +x envcli-x86_64-unknown-linux-gnu
            sudo mv envcli-x86_64-unknown-linux-gnu /usr/local/bin/envcli
            ```

            #### Linux ARM64
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/envcli-aarch64-unknown-linux-gnu
            chmod +x envcli-aarch64-unknown-linux-gnu
            sudo mv envcli-aarch64-unknown-linux-gnu /usr/local/bin/envcli
            ```

            #### Windows
            ```powershell
            # ä¸‹è½½å¹¶æ·»åŠ åˆ° PATH
            Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/envcli-x86_64-pc-windows-msvc.exe" -OutFile "envcli.exe"
            # å°† envcli.exe æ‰€åœ¨ç›®å½•æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡
            ```

            #### macOS
            ```bash
            # Intel èŠ¯ç‰‡
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/envcli-x86_64-apple-darwin
            chmod +x envcli-x86_64-apple-darwin
            sudo mv envcli-x86_64-apple-darwin /usr/local/bin/envcli

            # Apple Silicon èŠ¯ç‰‡
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/envcli-aarch64-apple-darwin
            chmod +x envcli-aarch64-apple-darwin
            sudo mv envcli-aarch64-apple-darwin /usr/local/bin/envcli
            ```

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§

            - âœ… **è·¨å¹³å°æ”¯æŒ**: Windows, Linux, macOS
            - âœ… **å¤šå±‚é…ç½®**: Local / Project / User / System
            - âœ… **å¯¼å…¥å¯¼å‡º**: `.env` ä¸ `json` æ ¼å¼
            - âœ… **è¿è¡Œæ³¨å…¥**: `run --env ... -- <command>`
            - âœ… **è¯Šæ–­ä¸ç¼“å­˜**: `doctor` + `cache` + `config`

            ### ğŸ“– ä½¿ç”¨ç¤ºä¾‹

            ```bash
            envcli set DB_HOST localhost --target project
            envcli get DB_HOST
            envcli export --format json > env.json
            envcli run --env APP_ENV=dev -- cargo run
            ```

            ### ğŸ” SHA256 æ ¡éªŒ

            æ¯ä¸ªå‘å¸ƒæ–‡ä»¶éƒ½é™„å¸¦ `.sha256` æ ¡éªŒæ–‡ä»¶ï¼Œç”¨äºéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚

            ```bash
            # Linux/macOS
            shasum -a 256 -c envcli-x86_64-unknown-linux-gnu.sha256

            # Windows (PowerShell)
            Get-FileHash -Algorithm SHA256 -Path envcli-x86_64-pc-windows-msvc.exe
            ```

            ### ğŸ› å·²çŸ¥é—®é¢˜

            - Windows æœºå™¨çº§ç¯å¢ƒå˜é‡éœ€è¦ç®¡ç†å‘˜æƒé™
            - Unix ç³»ç»Ÿæœºå™¨çº§å˜é‡ä»…æ”¯æŒç”¨æˆ·çº§ï¼ˆglobalï¼‰

            ### ğŸ”„ æ›´æ–°æ—¥å¿—

            æŸ¥çœ‹ `docs/CHANGELOG.md` è·å–è¯¦ç»†æ›´æ–°ä¿¡æ¯ã€‚

            ---

            **Git æäº¤**: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
